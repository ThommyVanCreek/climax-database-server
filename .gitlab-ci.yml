# ═══════════════════════════════════════════════════════════════════════════════
# ClimaX Database Server - GitLab CI/CD Pipeline
# ═══════════════════════════════════════════════════════════════════════════════
# 
# This pipeline builds, tests, and deploys the Flask API server.
# 
# Required CI/CD Variables (Settings → CI/CD → Variables):
#   - CI_REGISTRY_USER: Docker registry username (auto-provided for GitLab Registry)
#   - CI_REGISTRY_PASSWORD: Docker registry password (auto-provided for GitLab Registry)
#   - DB_HOST: PostgreSQL host
#   - DB_PORT: PostgreSQL port
#   - DB_NAME: Database name
#   - DB_USER: Database user
#   - DB_PASSWORD: Database password (masked)
#   - API_KEY_WRITE: Write API key for ESP32 (masked)
#   - API_KEY_READ: Read API key for clients (masked)
#   - DEPLOY_HOST: SSH host for deployment
#   - DEPLOY_USER: SSH user for deployment
#   - DEPLOY_SSH_KEY: SSH private key for deployment (File type)
#
# ═══════════════════════════════════════════════════════════════════════════════

stages:
  - test
  - build
  - release
  - deploy

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  PYTHON_VERSION: "3.11"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# ─────────────────────────────────────────────────────────────────────────────────
# Templates
# ─────────────────────────────────────────────────────────────────────────────────

.python_template: &python_template
  image: python:${PYTHON_VERSION}-slim
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .pip-cache/
  before_script:
    - pip install --cache-dir .pip-cache -r requirements.txt

.docker_template: &docker_template
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

# ─────────────────────────────────────────────────────────────────────────────────
# Test Stage
# ─────────────────────────────────────────────────────────────────────────────────

lint:
  <<: *python_template
  stage: test
  script:
    - pip install flake8
    - flake8 database_server.py --max-line-length=120 --ignore=E501,W503
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

syntax-check:
  <<: *python_template
  stage: test
  script:
    - python -m py_compile database_server.py
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Health check test (imports and basic validation)
import-test:
  <<: *python_template
  stage: test
  script:
    - python -c "from database_server import app; print('Import successful')"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ─────────────────────────────────────────────────────────────────────────────────
# Build Stage
# ─────────────────────────────────────────────────────────────────────────────────

build:
  <<: *docker_template
  stage: build
  script:
    - |
      docker build \
        --tag $IMAGE_NAME:$CI_COMMIT_SHA \
        --tag $IMAGE_NAME:$CI_COMMIT_REF_SLUG \
        .
    - docker push $IMAGE_NAME:$CI_COMMIT_SHA
    - docker push $IMAGE_NAME:$CI_COMMIT_REF_SLUG
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ─────────────────────────────────────────────────────────────────────────────────
# Release Stage
# ─────────────────────────────────────────────────────────────────────────────────

release:
  <<: *docker_template
  stage: release
  script:
    - docker pull $IMAGE_NAME:$CI_COMMIT_SHA
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHA $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - build

release-tag:
  <<: *docker_template
  stage: release
  script:
    - docker pull $IMAGE_NAME:$CI_COMMIT_SHA
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHA $IMAGE_NAME:$CI_COMMIT_TAG
    - docker push $IMAGE_NAME:$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG
  needs:
    - build

# ─────────────────────────────────────────────────────────────────────────────────
# Deploy Stage
# ─────────────────────────────────────────────────────────────────────────────────

# Run database migrations before deploying
migrate:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client postgresql-client
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null
  script:
    # Copy and run migration via SSH tunnel
    - |
      scp database_schema.sql $DEPLOY_USER@$DEPLOY_HOST:/tmp/
      ssh $DEPLOY_USER@$DEPLOY_HOST << EOF
        PGPASSWORD='$DB_PASSWORD' psql -h $DB_HOST -U $DB_USER -d $DB_NAME -f /tmp/database_schema.sql
        rm /tmp/database_schema.sql
      EOF
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      changes:
        - database_schema.sql
  allow_failure: true

deploy-staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << EOF
        cd /opt/climax
        docker compose pull api
        docker compose up -d api
        docker image prune -f
        # Wait for health check
        sleep 5
        curl -f http://localhost:5000/api/health || exit 1
      EOF
  environment:
    name: staging
    url: https://api-staging.climax.example.com
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  needs:
    - release

deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_SSH_KEY_PROD" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST_PROD >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - |
      ssh $DEPLOY_USER_PROD@$DEPLOY_HOST_PROD << EOF
        cd /opt/climax
        docker compose pull api
        docker compose up -d api
        docker image prune -f
        sleep 5
        curl -f http://localhost:5000/api/health || exit 1
      EOF
  environment:
    name: production
    url: https://api.climax.example.com
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
  needs:
    - release-tag
